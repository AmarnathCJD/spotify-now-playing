package handler

import (
	"encoding/base64"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"os"
	"strconv"
	"strings"

	dotenv "github.com/joho/godotenv"
)

type SpotifyWidget struct {
	Artists    string `json:"artists"`
	Title      string `json:"title"`
	Image      string `json:"image"`
	IsPlaying  bool   `json:"is_playing"`
	URL        string `json:"url"`
	DurationMs int    `json:"duration_ms"`
	ProgressMs int    `json:"progress_ms"`
	Timestamp  int64  `json:"timestamp"`
}

func CurrentPlaying(w http.ResponseWriter, r *http.Request) {
	dotenv.Load()

	var v = 1
	version := r.URL.Query().Get("v")
	if version == "2" {
		v = 2
	}

	if r.URL.Query().Get("s") != "1" {
		var thirdPartyCopyPreventionData = os.Getenv("THIRD_PARTY_COPY_PREVENTION_DATA")

		var ThirdPartyCopyPreventionData SpotifyWidget
		if err := json.Unmarshal([]byte(thirdPartyCopyPreventionData), &ThirdPartyCopyPreventionData); err != nil {
			http.Error(w, `{"error": "failed to parse 'THIRD_PARTY_COPY_PREVENTION_DATA': `+err.Error()+`"}`, http.StatusInternalServerError)
			return
		}

		var resp = []byte(createSpotifyWidget(ThirdPartyCopyPreventionData, false, v))
		w.Header().Set("Content-Type", "image/svg+xml")
		w.Write(resp)
		return
	}

	svg := r.URL.Query().Get("svg") == "true"
	dark := r.URL.Query().Get("dark") == "true"
	var SPOTIFY_COOKIE = os.Getenv("SPOTIFY_COOKIE")

	if SPOTIFY_COOKIE == "" {
		http.Error(w, `{"error": "missing 'SPOTIFY_COOKIE', set your 'sp_dc' cookie from open.spotify.com"}`, http.StatusInternalServerError)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	w.Header().Set("Access-Control-Allow-Origin", "*")

	currentPlaying, err := getCurrentPlaying(SPOTIFY_COOKIE, svg, dark, v)
	if err != nil {
		http.Error(w, `{"error": "failed to get current playing song: `+err.Error()+`"}`, http.StatusInternalServerError)
		return
	}

	if svg {
		w.Header().Set("Content-Type", "image/svg+xml")
	} else {
		w.Header().Set("Content-Type", "application/json")
	}

	w.Write(currentPlaying)
}

func getCurrentPlaying(cookie string, svg bool, darkMode bool, v int) ([]byte, error) {
	client := &http.Client{}
	req, err := http.NewRequest("GET", "https://open.spotify.com/get_access_token", nil)
	if err != nil {
		return nil, err
	}
	req.Header.Set("cookie", "sp_dc="+cookie)
	resp, err := client.Do(req)
	if err != nil {
		return nil, err
	}

	defer resp.Body.Close()
	var respBody struct {
		AccessToken string `json:"accessToken"`
		IsAnonymous bool   `json:"isAnonymous"`
	}

	json.NewDecoder(resp.Body).Decode(&respBody)

	req, _ = http.NewRequest("GET", "https://api.spotify.com/v1/me/player/currently-playing", nil)
	req.Header.Set("Authorization", "Bearer "+respBody.AccessToken)

	resp, err = client.Do(req)
	if err != nil {
		return nil, err
	}

	defer resp.Body.Close()

	var currentTrack CurrentTrack
	json.NewDecoder(resp.Body).Decode(&currentTrack)

	if svg && (currentTrack.Item.Name == "") {
		svg, _ := base64.StdEncoding.DecodeString(`PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMjAiIGhlaWdodD0iODQiIGFyaWEtbGFiZWxsZWRieT0iY2FyZFRpdGxlIj48Zm9yZWlnbk9iamVjdCB3aWR0aD0iMzIwIiBoZWlnaHQ9Ijg0Ij48c3R5bGU+ZGl2e2ZvbnQtZmFtaWx5Oi1hcHBsZS1zeXN0ZW0sQmxpbmtNYWNTeXN0ZW1Gb250LFNlZ29lIFVJLEhlbHZldGljYSxBcmlhbCxzYW5zLXNlcmlmLEFwcGxlIENvbG9yIEVtb2ppLFNlZ29lIFVJIEVtb2ppfS5wbGF5aW5ne2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO2FsaWduLWl0ZW1zOmNlbnRlcjtjb2xvcjojNTNiMTRmO2ZvbnQtd2VpZ2h0OjcwMDt0ZXh0LWFsaWduOmNlbnRlcjttYXJnaW4tYm90dG9tOjhweH0ubm90LXBsYXl7Y29sb3I6IzU4ZmYxNjt0ZXh0LWFsaWduOmNlbnRlcjttYXJnaW4tYm90dG9tOjB9PC9zdHlsZT48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBjbGFzcz0iY29udGFpbmVyIj48ZGl2IGNsYXNzPSJwbGF5aW5nIG5vdC1wbGF5Ij5Ob3RoaW5nIHBsYXlpbmcgb24gU3BvdGlmeTwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L3N2Zz4=`)

		if v == 2 {
			svg, _ = base64.StdEncoding.DecodeString(`PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMTQwIiBhcmlhLWxhYmVsbGVkYnk9ImNhcmRUaXRsZSI+PGZvcmVpZ25PYmplY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSIxNDAiPjxzdHlsZT5Aa2V5ZnJhbWVzIGZhZGVJbkNvbnRhaW5lcnswJXtvcGFjaXR5OjA7dHJhbnNmb3JtOnRyYW5zbGF0ZVkoNnB4KX10b3tvcGFjaXR5OjE7dHJhbnNmb3JtOnRyYW5zbGF0ZVkoMCl9fWRpdntmb250LWZhbWlseTotYXBwbGUtc3lzdGVtLEJsaW5rTWFjU3lzdGVtRm9udCxTZWdvZSBVSSxIZWx2ZXRpY2EsQXJpYWwsc2Fucy1zZXJpZixBcHBsZSBDb2xvciBFbW9qaSxTZWdvZSBVSSBFbW9qaX0uY29udGFpbmVye2Rpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7cGFkZGluZzoxMnB4O2JvcmRlci1yYWRpdXM6MTJweDtiYWNrZ3JvdW5kLWNvbG9yOiMxMjEyMTI7Y29sb3I6I2ZmZjtib3gtc2hhZG93OjAgNnB4IDE0cHggcmdiYSgwLDAsMCwuNCk7YW5pbWF0aW9uOmZhZGVJbkNvbnRhaW5lciAuOHMgZWFzZS1vdXQ7anVzdGlmeS1jb250ZW50OmNlbnRlcjt0ZXh0LWFsaWduOmNlbnRlcjtmbGV4LWRpcmVjdGlvbjpjb2x1bW59Lm1lc3NhZ2V7Zm9udC1zaXplOjE2cHg7Zm9udC13ZWlnaHQ6NzAwO2NvbG9yOiNmZmY7bWFyZ2luLWJvdHRvbTo0cHh9LnN1Yi1tZXNzYWdle2ZvbnQtc2l6ZToxMnB4O2NvbG9yOiNiM2IzYjM7b3BhY2l0eTouOX08L3N0eWxlPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIGNsYXNzPSJjb250YWluZXIiPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIGZpbGw9IiMxREI5NTQiIGNsYXNzPSJiaSBiaS1zcG90aWZ5IiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik04IDBhOCA4IDAgMSAwIDAgMTZBOCA4IDAgMCAwIDggMG0zLjY2OSAxMS41MzhhLjUuNSAwIDAgMS0uNjg2LjE2NWMtMS44NzktMS4xNDctNC4yNDMtMS40MDctNy4wMjgtLjc3YS40OTkuNDk5IDAgMCAxLS4yMjItLjk3M2MzLjA0OC0uNjk2IDUuNjYyLS4zOTcgNy43Ny44OTJhLjUuNSAwIDAgMSAuMTY2LjY4Nm0uOTc5LTIuMTc4YS42MjQuNjI0IDAgMCAxLS44NTguMjA1Yy0yLjE1LTEuMzIxLTUuNDI4LTEuNzA0LTcuOTcyLS45MzJhLjYyNS42MjUgMCAwIDEtLjM2Mi0xLjE5NGMyLjkwNS0uODgxIDYuNTE3LS40NTQgOC45ODYgMS4wNjNhLjYyNC42MjQgMCAwIDEgLjIwNi44NThtLjA4NC0yLjI2OEMxMC4xNTQgNS41NiA1LjkgNS40MTkgMy40MzggNi4xNjZhLjc0OC43NDggMCAxIDEtLjQzNC0xLjQzMmMyLjgyNS0uODU3IDcuNTIzLS42OTIgMTAuNDkyIDEuMDdhLjc0Ny43NDcgMCAxIDEtLjc2NCAxLjI4OCIvPjwvc3ZnPjxkaXYgY2xhc3M9Im1lc3NhZ2UiPk5vIE11c2ljIEN1cnJlbnRseSBQbGF5aW5nPC9kaXY+PGRpdiBjbGFzcz0ic3ViLW1lc3NhZ2UiPkNvbm5lY3QgdG8gc3RhcnQgZW5qb3lpbmcgdHVuZXMhPC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjwvc3ZnPg==`)
		}

		if darkMode {
			svg, _ = base64.StdEncoding.DecodeString(`PHN2ZyBhcmlhLWxhYmVsbGVkYnk9Y2FyZFRpdGxlIGhlaWdodD04NCB3aWR0aD0zMjAgeG1sbnM9aHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmc+PGZvcmVpZ25PYmplY3QgaGVpZ2h0PTg0IHdpZHRoPTMyMD48c3R5bGU+ZGl2e2ZvbnQtZmFtaWx5Oi1hcHBsZS1zeXN0ZW0sQmxpbmtNYWNTeXN0ZW1Gb250LFNlZ29lIFVJLEhlbHZldGljYSxBcmlhbCxzYW5zLXNlcmlmLEFwcGxlIENvbG9yIEVtb2ppLFNlZ29lIFVJIEVtb2ppO2JhY2tncm91bmQtY29sb3I6IzFlMWUxZTtjb2xvcjojZmZmfS5wbGF5aW5ne2Rpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO2FsaWduLWl0ZW1zOmNlbnRlcjtmb250LXdlaWdodDo3MDA7dGV4dC1hbGlnbjpjZW50ZXI7bWFyZ2luLWJvdHRvbTo4cHh9Lm5vdC1wbGF5e2NvbG9yOiM1OGZmMTY7dGV4dC1hbGlnbjpjZW50ZXI7bWFyZ2luLWJvdHRvbTowfTwvc3R5bGU+PGRpdiBjbGFzcz1jb250YWluZXIgeG1sbnM9aHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbD48ZGl2IGNsYXNzPSJub3QtcGxheSBwbGF5aW5nIj5Ob3RoaW5nIHBsYXlpbmcgb24gU3BvdGlmeTwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48L3N2Zz4=`)

			return svg, nil
		}

		return svg, nil
	}

	result := SpotifyWidget{
		Timestamp:  currentTrack.Timestamp,
		ProgressMs: currentTrack.ProgressMs,
		Title:      currentTrack.Item.Name,
		DurationMs: currentTrack.Item.DurationMs,
		URL:        currentTrack.Item.ExternalUrls.Spotify,
		IsPlaying:  currentTrack.IsPlaying,
	}

	if len(currentTrack.Item.Artists) > 0 {
		result.Artists = func() string {
			var artists []string
			for _, artist := range currentTrack.Item.Artists {
				artists = append(artists, artist.Name)
				if len(artists) >= 2 {
					break
				}
			}
			return strings.Join(artists, ", ")
		}()
	}

	if len(currentTrack.Item.Album.Images) > 0 {
		result.Image = currentTrack.Item.Album.Images[0].URL
	}

	if svg {
		return []byte(createSpotifyWidget(result, darkMode, v)), nil
	}

	return json.MarshalIndent(result, "", "  ")
}

type CurrentTrack struct {
	Timestamp  int64 `json:"timestamp"`
	ProgressMs int   `json:"progress_ms"`
	Item       struct {
		Album struct {
			Images []struct {
				URL string `json:"url"`
			} `json:"images"`
		} `json:"album"`
		Artists []struct {
			Name string `json:"name"`
		} `json:"artists"`
		DurationMs   int `json:"duration_ms"`
		ExternalUrls struct {
			Spotify string `json:"spotify"`
		} `json:"external_urls"`
		Name string `json:"name"`
	} `json:"item"`
	IsPlaying bool `json:"is_playing"`
}

func createSpotifyWidget(currentTrack SpotifyWidget, darkMode bool, version int) string {
	svgTemplateBase64 := `PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMjAiIGhlaWdodD0iODQiIGFyaWEtbGFiZWxsZWRieT0iY2FyZFRpdGxlIj48Zm9yZWlnbk9iamVjdCB3aWR0aD0iMzIwIiBoZWlnaHQ9Ijg0Ij48c3R5bGU+QGtleWZyYW1lcyBzb3VuZHswJXtvcGFjaXR5Oi4zNTtoZWlnaHQ6M3B4fXRve29wYWNpdHk6MTtoZWlnaHQ6NnB4fX1kaXZ7Zm9udC1mYW1pbHk6LWFwcGxlLXN5c3RlbSxCbGlua01hY1N5c3RlbUZvbnQsU2Vnb2UgVUksSGVsdmV0aWNhLEFyaWFsLHNhbnMtc2VyaWYsQXBwbGUgQ29sb3IgRW1vamksU2Vnb2UgVUkgRW1vaml9LmNvbnRhaW5lcntkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2JvcmRlci1yYWRpdXM6MTBweDtwYWRkaW5nOjEwcHh9LmNvdmVyLWxpbmt7aGVpZ2h0OjY0cHh9LmNvdmVye2JvcmRlci1yYWRpdXM6MXB4O21hcmdpbi1yaWdodDoxMHB4fS5hcnRpc3R7Y29sb3I6IzEyMTIxMjtmb250LXdlaWdodDo1MDA7Zm9udC1zaXplOjE0cHg7bWFyZ2luLWJvdHRvbTozcHh9LnNvbmd7Y29sb3I6IzIxMjEyMjtmb250LXNpemU6MTRweDttYXJnaW4tYm90dG9tOjE4cHh9QG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTpsaWdodCl7LmFydGlzdHtjb2xvcjojMTIxMjEyfS5zb25ne2NvbG9yOiMyMTIxMjJ9fUBtZWRpYSAocHJlZmVycy1jb2xvci1zY2hlbWU6ZGFyayl7LmFydGlzdHtjb2xvcjojZjRmNGY0fS5zb25ne2NvbG9yOiNkYmRiZGN9fSNiYXJzLC5iYXJ7cG9zaXRpb246YWJzb2x1dGV9I2JhcnN7aGVpZ2h0OjZweDt3aWR0aDoyMjBweDtvdmVyZmxvdzpoaWRkZW47bWFyZ2luOi02cHggMCAwfS5iYXJ7YmFja2dyb3VuZDojNTNiMTRmO2JvdHRvbToxcHg7aGVpZ2h0OjNweDt3aWR0aDozcHg7YW5pbWF0aW9uOnNvdW5kIDBtcyAtODAwbXMgbGluZWFyIGluZmluaXRlIGFsdGVybmF0ZX0uYmFyOm50aC1jaGlsZCgxKXtsZWZ0OjFweDthbmltYXRpb24tZHVyYXRpb246NDk4bXN9LmJhcjpudGgtY2hpbGQoMil7bGVmdDo1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM4OG1zfS5iYXI6bnRoLWNoaWxkKDMpe2xlZnQ6OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTVtc30uYmFyOm50aC1jaGlsZCg0KXtsZWZ0OjEzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM1NW1zfS5iYXI6bnRoLWNoaWxkKDUpe2xlZnQ6MTdweDthbmltYXRpb24tZHVyYXRpb246NDM2bXN9LmJhcjpudGgtY2hpbGQoNil7bGVmdDoyMXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NDdtc30uYmFyOm50aC1jaGlsZCg3KXtsZWZ0OjI1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM2NW1zfS5iYXI6bnRoLWNoaWxkKDgpe2xlZnQ6MjlweDthbmltYXRpb24tZHVyYXRpb246Mzg5bXN9LmJhcjpudGgtY2hpbGQoOSl7bGVmdDozM3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NTltc30uYmFyOm50aC1jaGlsZCgxMCl7bGVmdDozN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzhtc30uYmFyOm50aC1jaGlsZCgxMSl7bGVmdDo0MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCgxMil7bGVmdDo0NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTNtc30uYmFyOm50aC1jaGlsZCgxMyl7bGVmdDo0OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NThtc30uYmFyOm50aC1jaGlsZCgxNCl7bGVmdDo1M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzBtc30uYmFyOm50aC1jaGlsZCgxNSl7bGVmdDo1N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNjRtc30uYmFyOm50aC1jaGlsZCgxNil7bGVmdDo2MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NTFtc30uYmFyOm50aC1jaGlsZCgxNyl7bGVmdDo2NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozNTJtc30uYmFyOm50aC1jaGlsZCgxOCl7bGVmdDo2OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozNTRtc30uYmFyOm50aC1jaGlsZCgxOSl7bGVmdDo3M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0Mzltc30uYmFyOm50aC1jaGlsZCgyMCl7bGVmdDo3N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCgyMSl7bGVmdDo4MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MzFtc30uYmFyOm50aC1jaGlsZCgyMil7bGVmdDo4NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MzJtc30uYmFyOm50aC1jaGlsZCgyMyl7bGVmdDo4OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzZtc30uYmFyOm50aC1jaGlsZCgyNCl7bGVmdDo5M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo1MDBtc30uYmFyOm50aC1jaGlsZCgyNSl7bGVmdDo5N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NjJtc30uYmFyOm50aC1jaGlsZCgyNil7bGVmdDoxMDFweDthbmltYXRpb24tZHVyYXRpb246NDY3bXN9LmJhcjpudGgtY2hpbGQoMjcpe2xlZnQ6MTA1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ4NW1zfS5iYXI6bnRoLWNoaWxkKDI4KXtsZWZ0OjEwOXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0OTRtc30uYmFyOm50aC1jaGlsZCgyOSl7bGVmdDoxMTNweDthbmltYXRpb24tZHVyYXRpb246MzY4bXN9LmJhcjpudGgtY2hpbGQoMzApLC5iYXI6bnRoLWNoaWxkKDMxKXtsZWZ0OjExN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNjNtc30uYmFyOm50aC1jaGlsZCgzMSl7bGVmdDoxMjFweH0uYmFyOm50aC1jaGlsZCgzMil7bGVmdDoxMjVweDthbmltYXRpb24tZHVyYXRpb246NDA2bXN9LmJhcjpudGgtY2hpbGQoMzMpe2xlZnQ6MTI5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ2N21zfS5iYXI6bnRoLWNoaWxkKDM0KXtsZWZ0OjEzM3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzRtc30uYmFyOm50aC1jaGlsZCgzNSl7bGVmdDoxMzdweDthbmltYXRpb24tZHVyYXRpb246NDIxbXN9LmJhcjpudGgtY2hpbGQoMzYpe2xlZnQ6MTQxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ5MG1zfS5iYXI6bnRoLWNoaWxkKDM3KXtsZWZ0OjE0NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOThtc30uYmFyOm50aC1jaGlsZCgzOCl7bGVmdDoxNDlweDthbmltYXRpb24tZHVyYXRpb246Mzg2bXN9LmJhcjpudGgtY2hpbGQoMzkpe2xlZnQ6MTUzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQyMW1zfS5iYXI6bnRoLWNoaWxkKDQwKXtsZWZ0OjE1N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MDJtc30uYmFyOm50aC1jaGlsZCg0MSl7bGVmdDoxNjFweDthbmltYXRpb24tZHVyYXRpb246NDg5bXN9LmJhcjpudGgtY2hpbGQoNDIpe2xlZnQ6MTY1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzM21zfS5iYXI6bnRoLWNoaWxkKDQzKXtsZWZ0OjE2OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NDFtc30uYmFyOm50aC1jaGlsZCg0NCl7bGVmdDoxNzNweDthbmltYXRpb24tZHVyYXRpb246NDA4bXN9LmJhcjpudGgtY2hpbGQoNDUpe2xlZnQ6MTc3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzOW1zfS5iYXI6bnRoLWNoaWxkKDQ2KXtsZWZ0OjE4MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTdtc30uYmFyOm50aC1jaGlsZCg0Nyl7bGVmdDoxODVweDthbmltYXRpb24tZHVyYXRpb246NDcxbXN9LmJhcjpudGgtY2hpbGQoNDgpe2xlZnQ6MTg5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzOW1zfS5iYXI6bnRoLWNoaWxkKDQ5KXtsZWZ0OjE5M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODVtc30uYmFyOm50aC1jaGlsZCg1MCl7bGVmdDoxOTdweDthbmltYXRpb24tZHVyYXRpb246MzY2bXN9LmJhcjpudGgtY2hpbGQoNTEpe2xlZnQ6MjAxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQwNm1zfS5iYXI6bnRoLWNoaWxkKDUyKXtsZWZ0OjIwNXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MThtc30uYmFyOm50aC1jaGlsZCg1Myl7bGVmdDoyMDlweDthbmltYXRpb24tZHVyYXRpb246NDgxbXN9LmJhcjpudGgtY2hpbGQoNTQpe2xlZnQ6MjEzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQxMW1zfS5iYXI6bnRoLWNoaWxkKDU1KXtsZWZ0OjIxN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNjZtc30uYmFyOm50aC1jaGlsZCg1Nil7bGVmdDoyMjFweDthbmltYXRpb24tZHVyYXRpb246NDg4bXN9LmJhcjpudGgtY2hpbGQoNTcpe2xlZnQ6MjI1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ2OG1zfS5iYXI6bnRoLWNoaWxkKDU4KXtsZWZ0OjIyOXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NzBtc30uYmFyOm50aC1jaGlsZCg1OSl7bGVmdDoyMzNweDthbmltYXRpb24tZHVyYXRpb246NDc1bXN9LmJhcjpudGgtY2hpbGQoNjApe2xlZnQ6MjM3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1NW1zfS5iYXI6bnRoLWNoaWxkKDYxKXtsZWZ0OjI0MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NDhtc30uYmFyOm50aC1jaGlsZCg2Mil7bGVmdDoyNDVweDthbmltYXRpb24tZHVyYXRpb246NDUybXN9LmJhcjpudGgtY2hpbGQoNjMpe2xlZnQ6MjQ5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ4OG1zfS5iYXI6bnRoLWNoaWxkKDY0KXtsZWZ0OjI1M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCg2NSl7bGVmdDoyNTdweDthbmltYXRpb24tZHVyYXRpb246NDM1bXN9LmJhcjpudGgtY2hpbGQoNjYpe2xlZnQ6MjYxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM2M21zfS5iYXI6bnRoLWNoaWxkKDY3KXtsZWZ0OjI2NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODdtc30uYmFyOm50aC1jaGlsZCg2OCl7bGVmdDoyNjlweDthbmltYXRpb24tZHVyYXRpb246MzU1bXN9LmJhcjpudGgtY2hpbGQoNjkpe2xlZnQ6MjczcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ0MG1zfS5iYXI6bnRoLWNoaWxkKDcwKXtsZWZ0OjI3N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NzNtc30uYmFyOm50aC1jaGlsZCg3MSl7bGVmdDoyODFweDthbmltYXRpb24tZHVyYXRpb246MzYwbXN9LmJhcjpudGgtY2hpbGQoNzIpe2xlZnQ6Mjg1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ0Mm1zfS5iYXI6bnRoLWNoaWxkKDczKXtsZWZ0OjI4OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTNtc30uYmFyOm50aC1jaGlsZCg3NCl7bGVmdDoyOTNweDthbmltYXRpb24tZHVyYXRpb246MzUzbXN9LmJhcjpudGgtY2hpbGQoNzUpe2xlZnQ6Mjk3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM3Mm1zfS5iYXI6bnRoLWNoaWxkKDc2KXtsZWZ0OjMwMXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCg3Nyl7bGVmdDozMDVweDthbmltYXRpb24tZHVyYXRpb246NDEzbXN9LmJhcjpudGgtY2hpbGQoNzgpe2xlZnQ6MzA5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM3NW1zfS5iYXI6bnRoLWNoaWxkKDc5KXtsZWZ0OjMxM3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0OTJtc30uYmFyOm50aC1jaGlsZCg4MCl7bGVmdDozMTdweDthbmltYXRpb24tZHVyYXRpb246Mzk0bXN9LmJhcjpudGgtY2hpbGQoODEpe2xlZnQ6MzIxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQxMG1zfS5iYXI6bnRoLWNoaWxkKDgyKXtsZWZ0OjMyNXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTltc30uYmFyOm50aC1jaGlsZCg4Myl7bGVmdDozMjlweDthbmltYXRpb24tZHVyYXRpb246MzU2bXN9LmJhcjpudGgtY2hpbGQoODQpe2xlZnQ6MzMzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1NW1zfS5iYXI6bnRoLWNoaWxkKDg1KXtsZWZ0OjMzN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTVtc30uYmFyOm50aC1jaGlsZCg4Nil7bGVmdDozNDFweDthbmltYXRpb24tZHVyYXRpb246Mzc5bXN9LmJhcjpudGgtY2hpbGQoODcpe2xlZnQ6MzQ1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM5OG1zfS5iYXI6bnRoLWNoaWxkKDg4KXtsZWZ0OjM0OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODRtc30uYmFyOm50aC1jaGlsZCg4OSl7bGVmdDozNTNweDthbmltYXRpb24tZHVyYXRpb246NDE0bXN9LmJhcjpudGgtY2hpbGQoOTApe2xlZnQ6MzU3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ3M21zfS5iYXI6bnRoLWNoaWxkKDkxKXtsZWZ0OjM2MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTFtc30uYmFyOm50aC1jaGlsZCg5Mil7bGVmdDozNjVweDthbmltYXRpb24tZHVyYXRpb246NDg2bXN9LmJhcjpudGgtY2hpbGQoOTMpe2xlZnQ6MzY5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzN21zfS5iYXI6bnRoLWNoaWxkKDk0KXtsZWZ0OjM3M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTdtc30uYmFyOm50aC1jaGlsZCg5NSl7bGVmdDozNzdweDthbmltYXRpb24tZHVyYXRpb246Mzg0bXN9LmJhcjpudGgtY2hpbGQoOTYpe2xlZnQ6MzgxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1N21zfS5iYXI6bnRoLWNoaWxkKDk3KXtsZWZ0OjM4NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODRtc30uYmFyOm50aC1jaGlsZCg5OCl7bGVmdDozODlweDthbmltYXRpb24tZHVyYXRpb246NDE5bXN9LmJhcjpudGgtY2hpbGQoOTkpe2xlZnQ6MzkzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1OW1zfS5iYXI6bnRoLWNoaWxkKDEwMCl7bGVmdDozOTdweDthbmltYXRpb24tZHVyYXRpb246NDE2bXN9PC9zdHlsZT48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBjbGFzcz0iY29udGFpbmVyIj48YSBocmVmPSJ7e3VybH19IiB0YXJnZXQ9Il9CTEFOSyIgY2xhc3M9ImNvdmVyLWxpbmsiPjxpbWcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHNyYz0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LCB7e2ltZ319IiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGNsYXNzPSJjb3ZlciIvPjwvYT48ZGl2IGNsYXNzPSJ0ZXh0LWNvbnRhaW5lciI+PGRpdiBjbGFzcz0iYXJ0aXN0Ij57e2FydGlzdHN9fTwvZGl2PjxkaXYgY2xhc3M9InNvbmciPnt7c29uZ319PC9kaXY+PGRpdiBpZD0iYmFycyI+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjwvc3ZnPg==` // This contains the template for the SVG that will be returned to the user.

	if version == 2 {
		svgTemplateBase64 = `PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MDAiIGhlaWdodD0iMTAwIiBhcmlhLWxhYmVsbGVkYnk9ImNhcmRUaXRsZSI+CiAgICA8Zm9yZWlnbk9iamVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjEwMCI+CiAgICAgICAgPHN0eWxlPgogICAgICAgICAgICBAa2V5ZnJhbWVzIHByb2dyZXNzQW5pbWF0aW9uIHsKICAgICAgICAgICAgICAgIDAlIHsgd2lkdGg6IHt7YmFyZmlsbH19JTsgfQogICAgICAgICAgICAgICAgMTAwJSB7IHdpZHRoOiAxMDAlOyB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEBrZXlmcmFtZXMgc291bmQgewogICAgICAgICAgICAgICAgMCUgeyB0cmFuc2Zvcm06IHNjYWxlWSgwLjQpOyBvcGFjaXR5OiAwLjY7IH0KICAgICAgICAgICAgICAgIHRvIHsgdHJhbnNmb3JtOiBzY2FsZVkoMS44KTsgb3BhY2l0eTogMTsgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBAa2V5ZnJhbWVzIGZhZGVJbkNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICAwJSB7IG9wYWNpdHk6IDA7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMHB4KTsgfQogICAgICAgICAgICAgICAgdG8geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMCk7IH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgQGtleWZyYW1lcyBmYWRlSW5UZXh0IHsKICAgICAgICAgICAgICAgIDAlIHsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgdG8geyBvcGFjaXR5OiAxOyB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEBrZXlmcmFtZXMgZmFkZUluU29uZyB7CiAgICAgICAgICAgICAgICAwJSB7IG9wYWNpdHk6IDA7IHRyYW5zZm9ybTogdHJhbnNsYXRlWCgtNXB4KTsgfQogICAgICAgICAgICAgICAgdG8geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCk7IH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgQGtleWZyYW1lcyBmYWRlSW5BcnRpc3QgewogICAgICAgICAgICAgICAgMCUgeyBvcGFjaXR5OiAwOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoNXB4KTsgfQogICAgICAgICAgICAgICAgdG8geyBvcGFjaXR5OiAxOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVgoMCk7IH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgQGtleWZyYW1lcyBmYWRlSW5CYXJzIHsKICAgICAgICAgICAgICAgIDAlIHsgb3BhY2l0eTogMDsgfQogICAgICAgICAgICAgICAgdG8geyBvcGFjaXR5OiAxOyB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRpdiB7CiAgICAgICAgICAgICAgICBmb250LWZhbWlseTogLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCAnU2Vnb2UgVUknLCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmLCAnQXBwbGUgQ29sb3IgRW1vamknLCAnU2Vnb2UgVUkgRW1vamknOwogICAgICAgICAgICB9CgogICAgICAgICAgICAuY29udGFpbmVyIHsKICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgICAgICAgICAgICAgcGFkZGluZzogMTJweDsKICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDEycHg7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMTIxMjEyOwogICAgICAgICAgICAgICAgY29sb3I6ICNmZmY7CiAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDhweCAxNnB4IHJnYmEoMCwgMCwgMCwgMC42KTsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogZmFkZUluQ29udGFpbmVyIDFzIGVhc2Utb3V0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAuY292ZXItbGluayB7CiAgICAgICAgICAgICAgICB3aWR0aDogNjRweDsKICAgICAgICAgICAgICAgIGhlaWdodDogNjRweDsKICAgICAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDRweDsKICAgICAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICAgICAgICAgICAgICBtYXJnaW4tcmlnaHQ6IDE2cHg7CiAgICAgICAgICAgICAgICBib3gtc2hhZG93OiAwIDRweCA4cHggcmdiYSgwLCAwLCAwLCAwLjQpOwogICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBmYWRlSW5UZXh0IDAuNnMgZWFzZS1vdXQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC50ZXh0LWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICBmbGV4OiAxOwogICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC5ub3ctcGxheWluZy1jb250YWluZXIgewogICAgICAgICAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsKICAgICAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAubm93LXBsYXlpbmcgewogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxMHB4OwogICAgICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsKICAgICAgICAgICAgICAgIGNvbG9yOiAjYjNiM2IzOwogICAgICAgICAgICAgICAgb3BhY2l0eTogMC45OwogICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBmYWRlSW5UZXh0IDAuOHMgZWFzZS1vdXQ7CiAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLnNvbmcgewogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxNnB4OwogICAgICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsKICAgICAgICAgICAgICAgIGNvbG9yOiAjZmZmOwogICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMXB4OwogICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBmYWRlSW5Tb25nIDFzIGVhc2U7CiAgICAgICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgICAgICAgICAgICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgICAgICAgICB9CgogICAgICAgICAgICAuYXJ0aXN0IHsKICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMTJweDsKICAgICAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgICAgICBjb2xvcjogI2IzYjNiMzsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogZmFkZUluQXJ0aXN0IDFzIGVhc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICNiYXJzLWFuZC1wcm9ncmVzcyB7CiAgICAgICAgICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgICAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICAgICAgICAgIGdhcDogOHB4OwogICAgICAgICAgICAgICAgbWFyZ2luLXRvcDogNnB4OwogICAgICAgICAgICB9CgogICAgICAgICAgICAucHJvZ3Jlc3MtYmFyLWNvbnRhaW5lciB7CiAgICAgICAgICAgICAgICBoZWlnaHQ6IDNweDsKICAgICAgICAgICAgICAgIHdpZHRoOiA0MCU7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMik7CiAgICAgICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMXB4OwogICAgICAgICAgICAgICAgbWFyZ2luLXRvcDogMnB4OwogICAgICAgICAgICAgICAgbWFyZ2luLWxlZnQ6IDIwcHg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC5wcm9ncmVzcy1iYXIgewogICAgICAgICAgICAgICAgaGVpZ2h0OiAxMDAlOwogICAgICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogI2UwZTBlMDsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogcHJvZ3Jlc3MgM3MgZWFzZS1pbi1vdXQgZm9yd2FyZHM7CiAgICAgICAgICAgICAgICBhbmltYXRpb246IHByb2dyZXNzQW5pbWF0aW9uIHt7cHNlY319cyBsaW5lYXIgZm9yd2FyZHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC5wcm9ncmVzcy10ZXh0IHsKICAgICAgICAgICAgICAgIGZvbnQtc2l6ZTogMTBweDsKICAgICAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgICAgICAgICAgICBjb2xvcjogI2IzYjNiMzsKICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAuOTsKICAgICAgICAgICAgICAgIG1hcmdpbi1sZWZ0OiAwcHg7CiAgICAgICAgICAgICAgICBtYXJnaW4tdG9wOiAycHg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICNiYXJzIHsKICAgICAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgICAgICAgICBnYXA6IDJweDsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogZmFkZUluQmFycyAxcyBlYXNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAuYmFyIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxZGI5NTQ7CiAgICAgICAgICAgICAgICB3aWR0aDogMnB4OwogICAgICAgICAgICAgICAgaGVpZ2h0OiA2cHg7CiAgICAgICAgICAgICAgICBhbmltYXRpb246IHNvdW5kIDQwMG1zIGxpbmVhciBpbmZpbml0ZSBhbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxcHg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC5iYXI6bnRoLWNoaWxkKDEpIHsgYW5pbWF0aW9uLWR1cmF0aW9uOiAzODBtczsgfQogICAgICAgICAgICAuYmFyOm50aC1jaGlsZCgyKSB7IGFuaW1hdGlvbi1kdXJhdGlvbjogNDIwbXM7IH0KICAgICAgICAgICAgLmJhcjpudGgtY2hpbGQoMykgeyBhbmltYXRpb24tZHVyYXRpb246IDM1MG1zOyB9CiAgICAgICAgICAgIC5iYXI6bnRoLWNoaWxkKDQpIHsgYW5pbWF0aW9uLWR1cmF0aW9uOiA0NTBtczsgfQogICAgICAgICAgICAuYmFyOm50aC1jaGlsZCg1KSB7IGFuaW1hdGlvbi1kdXJhdGlvbjogMzcwbXM7IH0KICAgICAgICAgICAgLmJhcjpudGgtY2hpbGQoNikgeyBhbmltYXRpb24tZHVyYXRpb246IDQ4MG1zOyB9CiAgICAgICAgICAgIC5iYXI6bnRoLWNoaWxkKDcpIHsgYW5pbWF0aW9uLWR1cmF0aW9uOiAzMjBtczsgfQogICAgICAgICAgICAuYmFyOm50aC1jaGlsZCg4KSB7IGFuaW1hdGlvbi1kdXJhdGlvbjogNDYwbXM7IH0KICAgICAgICAgICAgLmJhcjpudGgtY2hpbGQoOSkgeyBhbmltYXRpb24tZHVyYXRpb246IDQwMG1zOyB9CiAgICAgICAgICAgIC5iYXI6bnRoLWNoaWxkKDEwKSB7IGFuaW1hdGlvbi1kdXJhdGlvbjogMzMwbXM7IH0KICAgICAgICA8L3N0eWxlPgoKICAgICAgICA8ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICAgICAgPGEgaHJlZj0iaHR0cHM6Ly9zcG90aWZ5LmNvbSIgdGFyZ2V0PSJfQkxBTksiIGNsYXNzPSJjb3Zlci1saW5rIj4KICAgICAgICAgICAgICAgIDxpbWcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHNyYz0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LHt7aW1nfX0iIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgLz4KICAgICAgICAgICAgPC9hPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJ0ZXh0LWNvbnRhaW5lciI+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJub3ctcGxheWluZy1jb250YWluZXIiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im5vdy1wbGF5aW5nIj5Ob3cgUGxheWluZzo8L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTogZmxleDsgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsgZ2FwOiAycHg7Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJzb25nIj57e3Nvbmd9fTwvZGl2PgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImFydGlzdCI+e3thcnRpc3RzfX08L2Rpdj4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBpZD0iYmFycy1hbmQtcHJvZ3Jlc3MiIHN0eWxlPSJtYXJnaW4tdG9wOiA4cHg7Ij4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGlkPSJiYXJzIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9ncmVzcy1iYXItY29udGFpbmVyIj4KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0icHJvZ3Jlc3MtYmFyIj48L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJwcm9ncmVzcy10ZXh0Ij57e2N1cnJ9fSAvIHt7dG90YWx9fTwvZGl2PgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiBmaWxsPSIjMURCOTU0IiBjbGFzcz0iYmkgYmktc3BvdGlmeSIKICAgICAgICAgICAgICAgIHZpZXdCb3g9IjAgMCAxNiAxNiI+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNOCAwYTggOCAwIDEgMCAwIDE2QTggOCAwIDAgMCA4IDBtMy42NjkgMTEuNTM4YS41LjUgMCAwIDEtLjY4Ni4xNjVjLTEuODc5LTEuMTQ3LTQuMjQzLTEuNDA3LTcuMDI4LS43N2EuNDk5LjQ5OSAwIDAgMS0uMjIyLS45NzNjMy4wNDgtLjY5NiA1LjY2Mi0uMzk3IDcuNzcuODkyYS41LjUgMCAwIDEgLjE2Ni42ODZtLjk3OS0yLjE3OGEuNjI0LjYyNCAwIDAgMS0uODU4LjIwNWMtMi4xNS0xLjMyMS01LjQyOC0xLjcwNC03Ljk3Mi0uOTMyYS42MjUuNjI1IDAgMCAxLS4zNjItMS4xOTRjMi45MDUtLjg4MSA2LjUxNy0uNDU0IDguOTg2IDEuMDYzYS42MjQuNjI0IDAgMCAxIC4yMDYuODU4bS4wODQtMi4yNjhDMTAuMTU0IDUuNTYgNS45IDUuNDE5IDMuNDM4IDYuMTY2YS43NDguNzQ4IDAgMSAxLS40MzQtMS40MzJjMi44MjUtLjg1NyA3LjUyMy0uNjkyIDEwLjQ5MiAxLjA3YS43NDcuNzQ3IDAgMSAxLS43NjQgMS4yODgiIC8+CiAgICAgICAgICAgIDwvc3ZnPgogICAgICAgIDwvZGl2PgogICAgPC9mb3JlaWduT2JqZWN0Pgo8L3N2Zz4K`
	}

	svgTemplateBase64Dark := `PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMjAiIGhlaWdodD0iODQiIGFyaWEtbGFiZWxsZWRieT0iY2FyZFRpdGxlIj48Zm9yZWlnbk9iamVjdCB3aWR0aD0iMzIwIiBoZWlnaHQ9Ijg0Ij48c3R5bGU+QGtleWZyYW1lcyBzb3VuZHswJXtvcGFjaXR5Oi4zNTtoZWlnaHQ6M3B4fXRve29wYWNpdHk6MTtoZWlnaHQ6NnB4fX1kaXZ7Zm9udC1mYW1pbHk6LWFwcGxlLXN5c3RlbSxCbGlua01hY1N5c3RlbUZvbnQsU2Vnb2UgVUksSGVsdmV0aWNhLEFyaWFsLHNhbnMtc2VyaWYsQXBwbGUgQ29sb3IgRW1vamksU2Vnb2UgVUkgRW1vaml9LmNvbnRhaW5lcntkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2JvcmRlci1yYWRpdXM6MTBweDtwYWRkaW5nOjEwcHg7YmFja2dyb3VuZC1jb2xvcjojMWUxZTFlfS5jb3Zlci1saW5re2hlaWdodDo2NHB4fS5jb3Zlcntib3JkZXItcmFkaXVzOjFweDttYXJnaW4tcmlnaHQ6MTBweH0uYXJ0aXN0e2NvbG9yOiNmNGY0ZjQ7Zm9udC13ZWlnaHQ6NTAwO2ZvbnQtc2l6ZToxNHB4O21hcmdpbi1ib3R0b206M3B4fS5zb25ne2NvbG9yOiNkYmRiZGM7Zm9udC1zaXplOjE0cHg7bWFyZ2luLWJvdHRvbToxOHB4fSNiYXJzLC5iYXJ7cG9zaXRpb246YWJzb2x1dGV9I2JhcnN7aGVpZ2h0OjZweDt3aWR0aDoyMjBweDtvdmVyZmxvdzpoaWRkZW47bWFyZ2luOi02cHggMCAwfS5iYXJ7YmFja2dyb3VuZDojNTNiMTRmO2JvdHRvbToxcHg7aGVpZ2h0OjNweDt3aWR0aDozcHg7YW5pbWF0aW9uOnNvdW5kIDBtcyAtODAwbXMgbGluZWFyIGluZmluaXRlIGFsdGVybmF0ZX0uYmFyOm50aC1jaGlsZCgxKXtsZWZ0OjFweDthbmltYXRpb24tZHVyYXRpb246NDk4bXN9LmJhcjpudGgtY2hpbGQoMil7bGVmdDo1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM4OG1zfS5iYXI6bnRoLWNoaWxkKDMpe2xlZnQ6OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTVtc30uYmFyOm50aC1jaGlsZCg0KXtsZWZ0OjEzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM1NW1zfS5iYXI6bnRoLWNoaWxkKDUpe2xlZnQ6MTdweDthbmltYXRpb24tZHVyYXRpb246NDM2bXN9LmJhcjpudGgtY2hpbGQoNil7bGVmdDoyMXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NDdtc30uYmFyOm50aC1jaGlsZCg3KXtsZWZ0OjI1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM2NW1zfS5iYXI6bnRoLWNoaWxkKDgpe2xlZnQ6MjlweDthbmltYXRpb24tZHVyYXRpb246Mzg5bXN9LmJhcjpudGgtY2hpbGQoOSl7bGVmdDozM3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NTltc30uYmFyOm50aC1jaGlsZCgxMCl7bGVmdDozN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzhtc30uYmFyOm50aC1jaGlsZCgxMSl7bGVmdDo0MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCgxMil7bGVmdDo0NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTNtc30uYmFyOm50aC1jaGlsZCgxMyl7bGVmdDo0OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NThtc30uYmFyOm50aC1jaGlsZCgxNCl7bGVmdDo1M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzBtc30uYmFyOm50aC1jaGlsZCgxNSl7bGVmdDo1N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNjRtc30uYmFyOm50aC1jaGlsZCgxNil7bGVmdDo2MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NTFtc30uYmFyOm50aC1jaGlsZCgxNyl7bGVmdDo2NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozNTJtc30uYmFyOm50aC1jaGlsZCgxOCl7bGVmdDo2OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozNTRtc30uYmFyOm50aC1jaGlsZCgxOSl7bGVmdDo3M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0Mzltc30uYmFyOm50aC1jaGlsZCgyMCl7bGVmdDo3N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCgyMSl7bGVmdDo4MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MzFtc30uYmFyOm50aC1jaGlsZCgyMil7bGVmdDo4NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MzJtc30uYmFyOm50aC1jaGlsZCgyMyl7bGVmdDo4OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzZtc30uYmFyOm50aC1jaGlsZCgyNCl7bGVmdDo5M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo1MDBtc30uYmFyOm50aC1jaGlsZCgyNSl7bGVmdDo5N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NjJtc30uYmFyOm50aC1jaGlsZCgyNil7bGVmdDoxMDFweDthbmltYXRpb24tZHVyYXRpb246NDY3bXN9LmJhcjpudGgtY2hpbGQoMjcpe2xlZnQ6MTA1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ4NW1zfS5iYXI6bnRoLWNoaWxkKDI4KXtsZWZ0OjEwOXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0OTRtc30uYmFyOm50aC1jaGlsZCgyOSl7bGVmdDoxMTNweDthbmltYXRpb24tZHVyYXRpb246MzY4bXN9LmJhcjpudGgtY2hpbGQoMzApLC5iYXI6bnRoLWNoaWxkKDMxKXtsZWZ0OjExN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNjNtc30uYmFyOm50aC1jaGlsZCgzMSl7bGVmdDoxMjFweH0uYmFyOm50aC1jaGlsZCgzMil7bGVmdDoxMjVweDthbmltYXRpb24tZHVyYXRpb246NDA2bXN9LmJhcjpudGgtY2hpbGQoMzMpe2xlZnQ6MTI5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ2N21zfS5iYXI6bnRoLWNoaWxkKDM0KXtsZWZ0OjEzM3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNzRtc30uYmFyOm50aC1jaGlsZCgzNSl7bGVmdDoxMzdweDthbmltYXRpb24tZHVyYXRpb246NDIxbXN9LmJhcjpudGgtY2hpbGQoMzYpe2xlZnQ6MTQxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ5MG1zfS5iYXI6bnRoLWNoaWxkKDM3KXtsZWZ0OjE0NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOThtc30uYmFyOm50aC1jaGlsZCgzOCl7bGVmdDoxNDlweDthbmltYXRpb24tZHVyYXRpb246Mzg2bXN9LmJhcjpudGgtY2hpbGQoMzkpe2xlZnQ6MTUzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQyMW1zfS5iYXI6bnRoLWNoaWxkKDQwKXtsZWZ0OjE1N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MDJtc30uYmFyOm50aC1jaGlsZCg0MSl7bGVmdDoxNjFweDthbmltYXRpb24tZHVyYXRpb246NDg5bXN9LmJhcjpudGgtY2hpbGQoNDIpe2xlZnQ6MTY1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzM21zfS5iYXI6bnRoLWNoaWxkKDQzKXtsZWZ0OjE2OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NDFtc30uYmFyOm50aC1jaGlsZCg0NCl7bGVmdDoxNzNweDthbmltYXRpb24tZHVyYXRpb246NDA4bXN9LmJhcjpudGgtY2hpbGQoNDUpe2xlZnQ6MTc3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzOW1zfS5iYXI6bnRoLWNoaWxkKDQ2KXtsZWZ0OjE4MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTdtc30uYmFyOm50aC1jaGlsZCg0Nyl7bGVmdDoxODVweDthbmltYXRpb24tZHVyYXRpb246NDcxbXN9LmJhcjpudGgtY2hpbGQoNDgpe2xlZnQ6MTg5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzOW1zfS5iYXI6bnRoLWNoaWxkKDQ5KXtsZWZ0OjE5M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODVtc30uYmFyOm50aC1jaGlsZCg1MCl7bGVmdDoxOTdweDthbmltYXRpb24tZHVyYXRpb246MzY2bXN9LmJhcjpudGgtY2hpbGQoNTEpe2xlZnQ6MjAxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQwNm1zfS5iYXI6bnRoLWNoaWxkKDUyKXtsZWZ0OjIwNXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MThtc30uYmFyOm50aC1jaGlsZCg1Myl7bGVmdDoyMDlweDthbmltYXRpb24tZHVyYXRpb246NDgxbXN9LmJhcjpudGgtY2hpbGQoNTQpe2xlZnQ6MjEzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQxMW1zfS5iYXI6bnRoLWNoaWxkKDU1KXtsZWZ0OjIxN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozNjZtc30uYmFyOm50aC1jaGlsZCg1Nil7bGVmdDoyMjFweDthbmltYXRpb24tZHVyYXRpb246NDg4bXN9LmJhcjpudGgtY2hpbGQoNTcpe2xlZnQ6MjI1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ2OG1zfS5iYXI6bnRoLWNoaWxkKDU4KXtsZWZ0OjIyOXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NzBtc30uYmFyOm50aC1jaGlsZCg1OSl7bGVmdDoyMzNweDthbmltYXRpb24tZHVyYXRpb246NDc1bXN9LmJhcjpudGgtY2hpbGQoNjApe2xlZnQ6MjM3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1NW1zfS5iYXI6bnRoLWNoaWxkKDYxKXtsZWZ0OjI0MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NDhtc30uYmFyOm50aC1jaGlsZCg2Mil7bGVmdDoyNDVweDthbmltYXRpb24tZHVyYXRpb246NDUybXN9LmJhcjpudGgtY2hpbGQoNjMpe2xlZnQ6MjQ5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ4OG1zfS5iYXI6bnRoLWNoaWxkKDY0KXtsZWZ0OjI1M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCg2NSl7bGVmdDoyNTdweDthbmltYXRpb24tZHVyYXRpb246NDM1bXN9LmJhcjpudGgtY2hpbGQoNjYpe2xlZnQ6MjYxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM2M21zfS5iYXI6bnRoLWNoaWxkKDY3KXtsZWZ0OjI2NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODdtc30uYmFyOm50aC1jaGlsZCg2OCl7bGVmdDoyNjlweDthbmltYXRpb24tZHVyYXRpb246MzU1bXN9LmJhcjpudGgtY2hpbGQoNjkpe2xlZnQ6MjczcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ0MG1zfS5iYXI6bnRoLWNoaWxkKDcwKXtsZWZ0OjI3N3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0NzNtc30uYmFyOm50aC1jaGlsZCg3MSl7bGVmdDoyODFweDthbmltYXRpb24tZHVyYXRpb246MzYwbXN9LmJhcjpudGgtY2hpbGQoNzIpe2xlZnQ6Mjg1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ0Mm1zfS5iYXI6bnRoLWNoaWxkKDczKXtsZWZ0OjI4OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTNtc30uYmFyOm50aC1jaGlsZCg3NCl7bGVmdDoyOTNweDthbmltYXRpb24tZHVyYXRpb246MzUzbXN9LmJhcjpudGgtY2hpbGQoNzUpe2xlZnQ6Mjk3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM3Mm1zfS5iYXI6bnRoLWNoaWxkKDc2KXtsZWZ0OjMwMXB4O2FuaW1hdGlvbi1kdXJhdGlvbjozOTltc30uYmFyOm50aC1jaGlsZCg3Nyl7bGVmdDozMDVweDthbmltYXRpb24tZHVyYXRpb246NDEzbXN9LmJhcjpudGgtY2hpbGQoNzgpe2xlZnQ6MzA5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM3NW1zfS5iYXI6bnRoLWNoaWxkKDc5KXtsZWZ0OjMxM3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0OTJtc30uYmFyOm50aC1jaGlsZCg4MCl7bGVmdDozMTdweDthbmltYXRpb24tZHVyYXRpb246Mzk0bXN9LmJhcjpudGgtY2hpbGQoODEpe2xlZnQ6MzIxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQxMG1zfS5iYXI6bnRoLWNoaWxkKDgyKXtsZWZ0OjMyNXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTltc30uYmFyOm50aC1jaGlsZCg4Myl7bGVmdDozMjlweDthbmltYXRpb24tZHVyYXRpb246MzU2bXN9LmJhcjpudGgtY2hpbGQoODQpe2xlZnQ6MzMzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1NW1zfS5iYXI6bnRoLWNoaWxkKDg1KXtsZWZ0OjMzN3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTVtc30uYmFyOm50aC1jaGlsZCg4Nil7bGVmdDozNDFweDthbmltYXRpb24tZHVyYXRpb246Mzc5bXN9LmJhcjpudGgtY2hpbGQoODcpe2xlZnQ6MzQ1cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjM5OG1zfS5iYXI6bnRoLWNoaWxkKDg4KXtsZWZ0OjM0OXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODRtc30uYmFyOm50aC1jaGlsZCg4OSl7bGVmdDozNTNweDthbmltYXRpb24tZHVyYXRpb246NDE0bXN9LmJhcjpudGgtY2hpbGQoOTApe2xlZnQ6MzU3cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ3M21zfS5iYXI6bnRoLWNoaWxkKDkxKXtsZWZ0OjM2MXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTFtc30uYmFyOm50aC1jaGlsZCg5Mil7bGVmdDozNjVweDthbmltYXRpb24tZHVyYXRpb246NDg2bXN9LmJhcjpudGgtY2hpbGQoOTMpe2xlZnQ6MzY5cHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQzN21zfS5iYXI6bnRoLWNoaWxkKDk0KXtsZWZ0OjM3M3B4O2FuaW1hdGlvbi1kdXJhdGlvbjo0MTdtc30uYmFyOm50aC1jaGlsZCg5NSl7bGVmdDozNzdweDthbmltYXRpb24tZHVyYXRpb246Mzg0bXN9LmJhcjpudGgtY2hpbGQoOTYpe2xlZnQ6MzgxcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1N21zfS5iYXI6bnRoLWNoaWxkKDk3KXtsZWZ0OjM4NXB4O2FuaW1hdGlvbi1kdXJhdGlvbjo0ODRtc30uYmFyOm50aC1jaGlsZCg5OCl7bGVmdDozODlweDthbmltYXRpb24tZHVyYXRpb246NDE5bXN9LmJhcjpudGgtY2hpbGQoOTkpe2xlZnQ6MzkzcHg7YW5pbWF0aW9uLWR1cmF0aW9uOjQ1OW1zfS5iYXI6bnRoLWNoaWxkKDEwMCl7bGVmdDozOTdweDthbmltYXRpb24tZHVyYXRpb246NDE2bXN9PC9zdHlsZT48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBjbGFzcz0iY29udGFpbmVyIj48YSBocmVmPSJ7e3VybH19IiB0YXJnZXQ9Il9CTEFOSyIgY2xhc3M9ImNvdmVyLWxpbmsiPjxpbWcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHNyYz0iZGF0YTppbWFnZS9wbmc7YmFzZTY0LCB7e2ltZ319IiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIGNsYXNzPSJjb3ZlciIvPjwvYT48ZGl2IGNsYXNzPSJ0ZXh0LWNvbnRhaW5lciI+PGRpdiBjbGFzcz0iYXJ0aXN0Ij57e2FydGlzdHN9fTwvZGl2PjxkaXYgY2xhc3M9InNvbmciPnt7c29uZ319PC9kaXY+PGRpdiBpZD0iYmFycyI+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PGRpdiBjbGFzcz0iYmFyIi8+PC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjwvc3ZnPg==`

	if darkMode {
		svgTemplateBase64 = svgTemplateBase64Dark
	}

	svgTemplateBytes, _ := base64.StdEncoding.DecodeString(svgTemplateBase64)
	svgTemplate := string(svgTemplateBytes)

	trimName := func(name string) string {
		if len(name) > 35 {
			return name[:35] + "..."
		}
		return name
	}

	svgTemplate = strings.Replace(svgTemplate, "{{url}}", currentTrack.URL, -1)
	svgTemplate = strings.Replace(svgTemplate, "{{artists}}", currentTrack.Artists, -1)
	svgTemplate = strings.Replace(svgTemplate, "{{song}}", trimName(currentTrack.Title), -1)
	svgTemplate = strings.Replace(svgTemplate, "{{songSize}}", strconv.Itoa(deduceTitlePx(currentTrack.Title)), -1)

	svgTemplate = strings.Replace(svgTemplate, "{{barfill}}", strconv.Itoa(percentageComplete(currentTrack.ProgressMs, currentTrack.DurationMs)), -1)

	svgTemplate = strings.Replace(svgTemplate, "{{curr}}", msToMMSS(currentTrack.ProgressMs), -1)

	svgTemplate = strings.Replace(svgTemplate, "{{total}}", msToMMSS(currentTrack.DurationMs), -1)

	svgTemplate = strings.Replace(svgTemplate, "{{psec}}", strconv.Itoa(msToSeconds(currentTrack.DurationMs-currentTrack.ProgressMs)), -1)

	frames, steps := progressKeyframes(currentTrack.ProgressMs, currentTrack.DurationMs)

	svgTemplate = strings.Replace(svgTemplate, "{{timeCounter}}", frames, -1)

	svgTemplate = strings.Replace(svgTemplate, "{{keySteps}}", strconv.Itoa(steps), -1)

	imageURL := currentTrack.Image
	resp, err := http.Get(imageURL)
	if err != nil {
		return ""
	}

	defer resp.Body.Close()

	img, _ := io.ReadAll(resp.Body)
	imgBase64 := base64.StdEncoding.EncodeToString(img)

	svgTemplate = strings.Replace(svgTemplate, "{{img}}", imgBase64, -1)

	return svgTemplate
}

func deduceTitlePx(title string) int {
	size := 18
	if len(title) > 30 && len(title) <= 35 {
		size = 16
	} else if len(title) > 35 && len(title) <= 40 {
		size = 14
	} else if len(title) > 40 {
		size = 12
	}
	return size
}

func msToMMSS(ms int) string {
	minutes := ms / 60000
	seconds := (ms % 60000) / 1000
	return fmt.Sprintf("%d:%02d", minutes, seconds)
}

func percentageComplete(currentTime, duration int) int {
	return int((float64(currentTime) / float64(duration)) * 100)
}

func msToSeconds(ms int) int {
	return ms / 1000
}

// @keyframes timeCounter {
// 	0% { content: "0:00"; }
// 	16.67% { content: "0:30"; }
// 	33.33% { content: "1:00"; }
// 	50% { content: "1:30"; }
// 	66.67% { content: "2:00"; }
// 	83.33% { content: "2:30"; }
// 	100% { content: "3:00"; }
// }

func progressKeyframes(currMs, durrMs int) (string, int) {
	var steps = 0
	var keyframes strings.Builder
	keyframes.WriteString("@keyframes timeCounter {\n")
	// start at current time, then for each remaining second, add kyframe
	durr := msToSeconds(durrMs)
	curr := msToSeconds(currMs)

	keyframes.WriteString("0% { content: \"" + msToMMSS(currMs) + "\"; }\n")
	steps += 1
	for i := 1; i <= durr-curr; i++ {
		keyframes.WriteString(fmt.Sprintf("%f%% { content: \"%s\"; }\n", float64(i)/float64(durr)*100, msToMMSS(currMs+i*1000)))
		steps += 1
	}
	keyframes.WriteString("100% { content: \"" + msToMMSS(durrMs) + "\"; }\n")
	steps += 1
	keyframes.WriteString("}")
	return keyframes.String(), steps
}
